// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Enum for different types of donations (parity with old project)
enum DonationType {
  fiat
  crypto
  stock
}

/// Legacy donation model (parity with old project DB/table/columns)
model Donation {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Project Information
  projectSlug    String @map("project_slug")
  organizationId Int    @map("organization_id")

  // Donation Details
  donationType     DonationType @map("donation_type")
  pledgeAmount     Decimal      @db.Decimal(18, 8) @map("pledgeAmount")
  assetSymbol      String?      @map("asset_symbol")
  assetDescription String?      @map("asset_description")

  // Donor Information
  firstName  String? @map("first_name")
  lastName   String? @map("last_name")
  donorEmail String? @map("donor_email")

  // Donor Settings
  isAnonymous     Boolean @default(false) @map("is_anonymous")
  taxReceipt      Boolean @default(false) @map("tax_receipt")
  joinMailingList Boolean @default(false) @map("join_mailing_list")

  // Donor Social Profiles
  socialX                String? @map("social_x")
  socialXimageSrc        String? @map("social_x_image_src")
  socialFacebook         String? @map("social_facebook")
  socialFacebookimageSrc String? @map("social_Facebook_image_src")
  socialLinkedIn         String? @map("social_linkedin")
  socialLinkedInimageSrc String? @map("social_LinkedIn_image_src")

  // TGB 200 Response Values
  donationUuid   String? @unique @map("donation_uuid") // stock
  pledgeId       String? @unique @map("pledge_id") // crypto / fiat
  depositAddress String? @map("deposit_address") // crypto

  // Success Status
  success Boolean @default(false) @map("success")

  // Webflow processed for matching
  processed Boolean @default(false) @map("processed")

  // Webhook Event Related Fields
  transactionHash        String?   @map("transaction_hash")
  convertedAt            DateTime? @map("converted_at")
  netValueAmount         Decimal?  @map("net_value_amount")
  netValueCurrency       String?   @map("net_value_currency")
  grossAmount            Decimal?  @map("gross_amount")
  payoutAmount           Decimal?  @map("payout_amount") @db.Decimal(10, 2)
  payoutCurrency         String?   @map("payout_currency")
  externalId             String?   @map("external_id")
  campaignId             String?   @map("campaign_id")
  valueAtDonationTimeUSD Decimal?  @map("value_at_donation_time_usd") @db.Decimal(10, 2)
  currency               String?   @map("currency")
  amount                 Decimal?  @map("amount") @db.Decimal(10, 2)
  status                 String?   @map("status")
  timestampms            DateTime? @map("timestampms")
  eid                    String?   @map("eid")
  paymentMethod          String?   @map("payment_method")
  eventData              Json?     @map("event_data")

  // Relations
  webhookEvents WebhookEvent[] @relation("DonationWebhookEvents")

  @@map("donations")
}

/// Legacy model to store individual webhook events (parity with old project)
model WebhookEvent {
  id         Int      @id @default(autoincrement())
  eventType  String   @map("event_type")
  payload    Json // Decrypted payload
  receivedAt DateTime @default(now()) @map("received_at")
  processed  Boolean  @default(false)

  // Relation to Donation
  donation   Donation @relation("DonationWebhookEvents", fields: [donationId], references: [id])
  donationId Int      @map("donation_id")
  eid        String?  @unique @map("eid")

  @@map("webhook_events")
}

/// Legacy matching log model (parity with old project)
model MatchingDonationLog {
  id            Int      @id @default(autoincrement())
  donorId       String
  donationId    Int
  matchedAmount Decimal  @db.Decimal(10, 2)
  date          DateTime @default(now())
  projectSlug   String
}

/// Legacy logs model (parity with old project)
model Log {
  id        Int      @id @default(autoincrement())
  level     String   @map("level")
  message   String   @map("message")
  meta      Json?    @map("meta")
  timestamp DateTime @default(now()) @map("timestamp")

  @@map("logs")
}

model Project {
  id                  String   @id // Webflow ID
  name                String
  slug                String   @unique
  summary             String   @db.Text
  content             String?  @db.Text
  coverImage          String?
  status              String
  projectType         String?
  hidden              Boolean  @default(false)
  recurring           Boolean  @default(false)
  totalPaid           Float    @default(0)
  serviceFeesCollected Float   @default(0)
  website             String?
  github              String?
  twitter             String?
  discord             String?
  telegram            String?
  reddit              String?
  facebook            String?
  lastPublished       DateTime
  lastUpdated         DateTime
  createdOn           DateTime
  cachedAt            DateTime @default(now())
  
  donations           DonationPledge[]
  
  @@index([slug])
  @@index([status])
  @@index([hidden])
}

model DonationPledge {
  id                  String   @id @default(cuid())
  organizationId      Int
  projectSlug         String
  project             Project? @relation(fields: [projectSlug], references: [slug])
  pledgeCurrency      String
  pledgeAmount        Float
  receiptEmail        String
  firstName           String
  lastName            String
  addressLine1        String
  addressLine2        String?
  country             String
  state               String?
  city                String
  zipcode             String
  taxReceipt          Boolean  @default(false)
  isAnonymous         Boolean  @default(false)
  joinMailingList      Boolean  @default(false)
  socialX             String?
  socialFacebook      String?
  socialLinkedIn      String?
  
  // TGB response fields
  pledgeId            String?  @unique // From TGB API
  depositAddress      String?  // For crypto donations
  donationUuid        String?  // For stock donations
  donationType        String   // 'fiat' | 'crypto' | 'stock'
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([projectSlug])
  @@index([pledgeId])
  @@index([receiptEmail])
  @@index([createdAt])
}

model CacheEntry {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([key])
  @@index([expiresAt])
}

model Token {
  id           Int      @id @default(autoincrement())
  accessToken  String   @map("access_token")
  refreshToken String   @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  refreshedAt  DateTime @map("refreshed_at")

  @@map("tokens")
}
